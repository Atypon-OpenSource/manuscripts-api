# This is pretty much a copy of the app Dockerfile
FROM node:16

ARG APP_BASE_URL
ARG APP_DATA_BUCKET
ARG APP_FROM_EMAIL
ARG APP_JWT_SECRET
ARG APP_SERVER_SECRET
ARG APP_OAUTH_STATE_ENCRYPTION_KEY
ARG APP_PORT
ARG APP_USER_BUCKET
ARG APP_CLIENT_APPLICATIONS
ARG APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES
ARG APP_ALLOWED_CORS_ORIGINS
ARG APP_TEST_ACTION
ARG APP_DATABASE_URL
ARG APP_PRESSROOM_BASE_URL
ARG APP_PRESSROOM_APIKEY

ENV APP_BASE_URL="${APP_BASE_URL}"
ENV APP_DATA_BUCKET="${APP_DATA_BUCKET}"
ENV APP_FROM_EMAIL="${APP_FROM_EMAIL}"
ENV APP_JWT_SECRET="${APP_JWT_SECRET}"
ENV APP_SERVER_SECRET="${APP_SERVER_SECRET}"
ENV APP_OAUTH_STATE_ENCRYPTION_KEY="${APP_OAUTH_STATE_ENCRYPTION_KEY}"
ENV APP_PORT="${APP_PORT}"
ENV APP_USER_BUCKET="${APP_USER_BUCKET}"
ENV APP_CLIENT_APPLICATIONS="${APP_CLIENT_APPLICATIONS}"
ENV APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES="${APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES}"
ENV APP_ALLOWED_CORS_ORIGINS="${APP_ALLOWED_CORS_ORIGINS}"
ENV APP_TEST_ACTION="${APP_TEST_ACTION}"
ENV APP_PRESSROOM_BASE_URL="${APP_PRESSROOM_BASE_URL}"
ENV APP_PRESSROOM_APIKEY="${APP_PRESSROOM_APIKEY}"
ENV APP_DATABASE_URL="${APP_DATABASE_URL}"

WORKDIR /usr/src/app

COPY package.json ./
COPY yarn.lock ./

RUN yarn install --non-interactive --frozen-lock-file

COPY ./src ./src
COPY ./prisma ./prisma
COPY ./bin ./bin
COPY ./types ./types
COPY ./.env.example ./.env.example
COPY ./test ./test

COPY tsconfig.json tsconfig.build.json ./

COPY babel.config.js ./
COPY jest.config.*.test.js ./

RUN ./bin/build-env.js .env.example > .env

EXPOSE 3000

RUN yarn attach-prisma

RUN printenv

CMD yarn ${APP_TEST_ACTION}
