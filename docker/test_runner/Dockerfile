# This is pretty much a copy of the app Dockerfile
FROM node:12

ARG APP_COUCHBASE_ADMIN_USER
ARG APP_COUCHBASE_ADMIN_PASS
ARG APP_BASE_URL
ARG APP_DATA_BUCKET
ARG APP_DB_URI
ARG APP_COUCHBASE_HOSTNAME
ARG APP_COUCHBASE_RBAC_PASSWORD
ARG APP_FROM_EMAIL
ARG APP_GATEWAY_COOKIE_DOMAIN
ARG APP_PROJECTS_GATEWAY_COOKIE_DOMAIN
ARG APP_GATEWAY_HOSTNAME
ARG APP_GATEWAY_PUBLIC_PORT
ARG APP_GATEWAY_ADMIN_PORT
ARG APP_GOOGLE_AUTH_CALLBACK
ARG APP_GOOGLE_CLIENT_ID
ARG APP_GOOGLE_CLIENT_SECRET
ARG APP_JWT_SECRET
ARG APP_SERVER_SECRET
ARG APP_OAUTH_STATE_ENCRYPTION_KEY
ARG APP_PORT
ARG APP_USER_BUCKET
ARG APP_CLIENT_APPLICATIONS
ARG APP_AWS_ACCESS_KEY_ID
ARG APP_AWS_SECRET_ACCESS_KEY
ARG APP_AWS_REGION
ARG APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES
ARG APP_ALLOWED_CORS_ORIGINS
ARG APP_TEST_ACTION
ARG APP_DATABASE_URL
ARG APP_PRESSROOM_BASE_URL
ARG APP_PRESSROOM_APIKEY

ENV APP_COUCHBASE_ADMIN_USER="${APP_COUCHBASE_ADMIN_USER}"
ENV APP_COUCHBASE_ADMIN_PASS="${APP_COUCHBASE_ADMIN_PASS}"
ENV APP_BASE_URL="${APP_BASE_URL}"
ENV APP_DATA_BUCKET="${APP_DATA_BUCKET}"
ENV APP_DB_URI="${APP_DB_URI}"
ENV APP_GATEWAY_COOKIE_DOMAIN="${APP_GATEWAY_COOKIE_DOMAIN}"
ENV APP_PROJECTS_GATEWAY_COOKIE_DOMAIN="${APP_PROJECTS_GATEWAY_COOKIE_DOMAIN}"
ENV APP_COUCHBASE_HOSTNAME="${APP_COUCHBASE_HOSTNAME}"
ENV APP_COUCHBASE_RBAC_PASSWORD="${APP_COUCHBASE_RBAC_PASSWORD}"
ENV APP_FROM_EMAIL="${APP_FROM_EMAIL}"
ENV APP_GATEWAY_HOSTNAME="${APP_GATEWAY_HOSTNAME}"
ENV APP_GATEWAY_PUBLIC_PORT="${APP_GATEWAY_PUBLIC_PORT}"
ENV APP_GATEWAY_ADMIN_PORT="${APP_GATEWAY_ADMIN_PORT}"
ENV APP_GOOGLE_AUTH_CALLBACK="${APP_GOOGLE_AUTH_CALLBACK}"
ENV APP_GOOGLE_CLIENT_ID="${APP_GOOGLE_CLIENT_ID}"
ENV APP_GOOGLE_CLIENT_SECRET="${APP_GOOGLE_CLIENT_SECRET}"
ENV APP_JWT_SECRET="${APP_JWT_SECRET}"
ENV APP_SERVER_SECRET="${APP_SERVER_SECRET}"
ENV APP_OAUTH_STATE_ENCRYPTION_KEY="${APP_OAUTH_STATE_ENCRYPTION_KEY}"
ENV APP_PORT="${APP_PORT}"
ENV APP_USER_BUCKET="${APP_USER_BUCKET}"
ENV APP_CLIENT_APPLICATIONS="${APP_CLIENT_APPLICATIONS}"
ENV APP_AWS_ACCESS_KEY_ID="${APP_AWS_ACCESS_KEY_ID}"
ENV APP_AWS_SECRET_ACCESS_KEY="${APP_AWS_SECRET_ACCESS_KEY}"
ENV APP_AWS_REGION="${APP_AWS_REGION}"
ENV APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES="${APP_STORE_ONLY_SSL_TRANSMITTED_COOKIES}"
ENV APP_ALLOWED_CORS_ORIGINS="${APP_ALLOWED_CORS_ORIGINS}"
ENV APP_TEST_ACTION="${APP_TEST_ACTION}"
ENV APP_PRESSROOM_BASE_URL="${APP_PRESSROOM_BASE_URL}"
ENV APP_PRESSROOM_APIKEY="${APP_PRESSROOM_APIKEY}"
ENV APP_DATABASE_URL="${APP_DATABASE_URL}"
ENV WAIT_FOR_SYNC_GATEWAY="true"

WORKDIR /usr/src/app

COPY package.json ./
COPY package-lock.json ./

RUN npm ci

COPY ./src ./src
COPY ./prisma ./prisma
COPY ./bin ./bin
COPY ./types ./types
COPY ./.env.example ./.env.example
COPY ./test ./test

COPY tsconfig.json tsconfig.build.json ./
COPY docker/wait_for_couchbase.sh /opt
COPY docker/wait_for_n1ql_service.js /opt

COPY babel.config.js ./
COPY jest.config.*.test.js ./

RUN ./bin/build-env.js .env.example > .env

EXPOSE 3000

RUN npm run attach-prisma

CMD npm run ${APP_TEST_ACTION}