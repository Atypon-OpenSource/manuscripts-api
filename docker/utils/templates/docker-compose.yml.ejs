version: '3.4'

services:
  postgres:
    image: postgres
    hostname: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: test
    volumes:
      - /tmp/postgres-data:/var/lib/postgresql/data:z
    restart: unless-stopped

<% if (node_env == 'development' || node_env == 'production') { -%>
  app:
    depends_on:
      - postgres
    ports:
      - "<%- app_port %>:<%- app_port %>"
    image: app
    build:
      context: ../
      dockerfile: docker/app/Dockerfile
    environment:
      NODE_ENV: <%- node_env %>
      APP_BASE_URL: "<%- app_base_url %>"
      APP_ENABLE_NON_CONNECT_AUTH: "<%- app_enable_non_connect_auth -%>"
      APP_FROM_EMAIL: "<%- app_from_email %>"
      APP_JWT_SECRET: <%- app_jwt_secret %>
      APP_SERVER_SECRET: <%- app_server_secret %>
      APP_PORT: <%- app_port %>
      APP_ALLOWED_CORS_ORIGINS: <%- app_allowed_cors_origins %>
      APP_SKIP_ACCOUNT_VERIFICATION: <%- app_skip_account_verification %>
      APP_HASH_SALT_ROUNDS: <%- app_hash_salt_rounds %>
      APP_DATA_BUCKET: <%- app_data_bucket %>
      APP_USER_BUCKET: <%- app_user_bucket %>
      APP_API_SERVER_URL: <%- app_api_server_url %>
      APP_PRESSROOM_BASE_URL: <%- app_pressroom_base_url %>
      APP_PRESSROOM_APIKEY: <%- app_pressroom_apikey %>
      APP_CONTAINER_TOKEN_SCOPES: <%- app_container_token_scopes %>
      APP_DATABASE_URL: <%- app_database_url %>
<% } else { -%>
  test_runner:
    depends_on:
      - postgres
    image: test_runner
    build:
      context: ../
      dockerfile: docker/test_runner/Dockerfile
    environment:
      NODE_ENV: <%- node_env %>
      APP_BASE_URL: "<%- app_base_url %>"
      APP_FROM_EMAIL: "<%- app_from_email %>"
      APP_JWT_SECRET: <%- app_jwt_secret %>
      APP_SERVER_SECRET: <%- app_server_secret %>
      APP_PORT: <%- app_port %>
      APP_ALLOWED_CORS_ORIGINS: <%- app_allowed_cors_origins %>
      APP_TEST_ACTION: <%- app_test_action %>
      APP_HASH_SALT_ROUNDS: <%- app_hash_salt_rounds %>
      APP_DATA_BUCKET: <%- app_data_bucket %>
      APP_USER_BUCKET: <%- app_user_bucket %>
      APP_API_SERVER_URL: <%- app_api_server_url %>
      APP_PRESSROOM_BASE_URL: <%- app_pressroom_base_url %>
      APP_PRESSROOM_APIKEY: <%- app_pressroom_apikey %>
      APP_CONTAINER_TOKEN_SCOPES: <%- app_container_token_scopes %>
      APP_DATABASE_URL: <%- app_database_url %>
<% } -%>
